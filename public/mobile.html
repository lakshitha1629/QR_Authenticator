<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
</head>
<body>
    <h1>Scan QR Code</h1>
    
    <video id="video" style="width: 100%; height: auto;"></video>
    <p id="result">No QR code detected yet</p>

    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        window.addEventListener('load', async function() {
            const codeReader = new ZXing.BrowserQRCodeReader();
            const videoElement = document.getElementById('video');
            const resultElement = document.getElementById('result');

            try {
                // Get all available video devices (cameras)
                const videoInputDevices = await codeReader.getVideoInputDevices();
                
                if (videoInputDevices.length === 0) {
                    throw new Error('No camera devices found.');
                }

                // Select the first available device or allow the user to choose
                const selectedDeviceId = videoInputDevices.length > 1 ? videoInputDevices[1].deviceId : videoInputDevices[0].deviceId;

                // Start the video stream from the selected device
                await codeReader.decodeOnceFromVideoDevice(selectedDeviceId, 'video').then(async result => {
                    resultElement.textContent = `QR Code detected: ${result.text}`;
                    console.log(result.text); // Process the scanned QR code here

                    // Here, we assume the QR code contains the sessionId. 
                    // You may want to add a more complex logic depending on your QR code data format.
                    const sessionId = result.text; // Use the QR code text as the session ID

                    // Collect user credentials (prompt for email and password)
                    const email = prompt("Enter your email:");
                    const password = prompt("Enter your password:");

                    // Open WebSocket connection
                    const ws = new WebSocket('ws://https://qr-authenticator.onrender.com:4000'); // Replace with your server address

                    ws.onopen = () => {
                        console.log("WebSocket connected");
                        // Send email, password, and session ID to the server
                        ws.send(`${email}:${password}`);
                    };

                    ws.onmessage = (message) => {
                        console.log('Message from server:', message.data);
                        if (message.data === 'authenticated') {
                            alert('You are authenticated!');
                            // Redirect to the dashboard
                            window.location.href = '/dashboard'; // Redirect after authentication
                        } else {
                            alert('Authentication failed. Please check your credentials.');
                        }
                    };
                }).catch(err => {
                    console.error('QR Code scan failed:', err);
                    resultElement.textContent = 'Failed to scan QR code or camera permission denied.';
                });
            } catch (err) {
                console.error('Error accessing video devices: ', err);
                resultElement.textContent = 'No QR code detected or camera permission denied';
            }
        });
    </script>
</body>
</html>
